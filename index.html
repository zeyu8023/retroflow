<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RetroFlow æº¯å…‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* æ˜ è¿¹é£æ ¼ï¼šæ·±è‰²ç»ç’ƒæ‹Ÿæ€ */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .glass {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .glass-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .active-tab {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.4);
        }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 min-h-screen selection:bg-blue-500 selection:text-white">
    <div id="app" class="max-w-lg mx-auto min-h-screen flex flex-col relative pb-20">
        
        <div class="px-6 py-6 flex justify-between items-end sticky top-0 z-40 bg-[#0f172a]/90 backdrop-blur-md">
            <div>
                <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400 tracking-tight">RetroFlow</h1>
                <p class="text-xs text-slate-500 font-medium tracking-widest uppercase mt-1">NAS Traffic Monitor</p>
            </div>
            <div class="flex gap-2">
                <button @click="currentTab = 'live'" :class="['px-3 py-1 text-xs rounded-full transition-all', currentTab === 'live' ? 'active-tab' : 'text-slate-500 hover:text-slate-300']">å®æ—¶</button>
                <button @click="currentTab = 'report'; loadHistory('day')" :class="['px-3 py-1 text-xs rounded-full transition-all', currentTab === 'report' ? 'active-tab' : 'text-slate-500 hover:text-slate-300']">æŠ¥è¡¨</button>
            </div>
        </div>

        <div v-show="currentTab === 'live'" class="px-6 space-y-6 animate-fade-in">
            <div class="glass rounded-3xl p-6 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-blue-600 rounded-full blur-[80px] opacity-20"></div>
                <div class="relative z-10 text-center">
                    <p class="text-slate-400 text-xs uppercase tracking-wider mb-2">Total Downlink</p>
                    <div class="text-5xl font-bold text-white font-mono tracking-tighter">
                        {{ formatSpeed(totalSpeedDown) }}<span class="text-lg text-slate-500 font-normal ml-1">/s</span>
                    </div>
                    <div class="mt-6 grid grid-cols-2 gap-4 border-t border-white/5 pt-4">
                        <div>
                            <div class="text-xs text-slate-500 mb-1">æ€»ä¸Šä¼ </div>
                            <div class="text-emerald-400 font-mono text-sm">{{ formatBytes(totalUpload) }}</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500 mb-1">æ€»ä¸‹è½½</div>
                            <div class="text-blue-400 font-mono text-sm">{{ formatBytes(totalDownload) }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h2 class="text-sm font-bold text-slate-500 mb-4 px-1">æ­£åœ¨è¿è¡Œ</h2>
                <div class="space-y-3">
                    <div v-for="item in sortedStats" :key="item.name" class="glass-card rounded-2xl p-4 flex items-center justify-between group hover:bg-white/5 transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center text-xl shadow-inner border border-white/5">
                                {{ getIcon(item.name) }}
                            </div>
                            <div>
                                <h3 class="font-bold text-sm text-slate-200">{{ item.name }}</h3>
                                <div class="text-[10px] text-slate-500 bg-slate-800/50 px-1.5 py-0.5 rounded inline-block mt-1 border border-white/5">{{ item.type }}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-mono text-xs text-blue-400 mb-1">â†“ {{ formatBytes(item.download) }}</div>
                            <div class="font-mono text-xs text-emerald-500/80">â†‘ {{ formatBytes(item.upload) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'report'" class="px-6 space-y-6">
            <div class="flex bg-slate-800/50 p-1 rounded-xl">
                <button @click="loadHistory('day')" :class="['flex-1 py-1.5 text-xs rounded-lg transition-all', reportRange === 'day' ? 'bg-slate-700 text-white shadow' : 'text-slate-400']">ä»Šæ—¥</button>
                <button @click="loadHistory('month')" :class="['flex-1 py-1.5 text-xs rounded-lg transition-all', reportRange === 'month' ? 'bg-slate-700 text-white shadow' : 'text-slate-400']">æœ¬æœˆ</button>
                <button @click="loadHistory('year')" :class="['flex-1 py-1.5 text-xs rounded-lg transition-all', reportRange === 'year' ? 'bg-slate-700 text-white shadow' : 'text-slate-400']">ä»Šå¹´</button>
            </div>

            <div class="glass rounded-2xl p-4">
                <h3 class="text-xs text-slate-500 mb-4">æµé‡è¶‹åŠ¿</h3>
                <div id="trendChart" style="width: 100%; height: 200px;"></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="glass-card rounded-2xl p-4 text-center">
                    <p class="text-xs text-slate-500 mb-1">å‘¨æœŸæ€»ä¸‹è½½</p>
                    <p class="text-xl font-bold text-blue-400 font-mono">{{ formatBytes(reportTotalDown) }}</p>
                </div>
                <div class="glass-card rounded-2xl p-4 text-center">
                    <p class="text-xs text-slate-500 mb-1">å‘¨æœŸæ€»ä¸Šä¼ </p>
                    <p class="text-xl font-bold text-emerald-400 font-mono">{{ formatBytes(reportTotalUp) }}</p>
                </div>
            </div>

            <button @click="generatePoster" class="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl text-sm font-bold shadow-lg shadow-blue-900/50 active:scale-95 transition-transform flex items-center justify-center gap-2">
                <span class="text-lg">ğŸ“¸</span> ç”Ÿæˆ{{ getReportTitle() }}æµ·æŠ¥
            </button>
        </div>

        <div id="poster-node" class="fixed top-0 left-0 w-[375px] bg-[#0f172a] p-8 -z-50 pointer-events-none opacity-0">
            <div class="border border-slate-700 rounded-3xl p-6 bg-gradient-to-b from-slate-800 to-[#0f172a] relative overflow-hidden">
                <div class="absolute -top-20 -right-20 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl"></div>
                <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-purple-500"></div>

                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-white mb-1">RetroFlow</h1>
                            <p class="text-sm text-slate-400">æµé‡ç»Ÿè®¡æŠ¥å‘Š</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-500 uppercase tracking-widest">DATE</p>
                            <p class="text-sm text-white font-mono">{{ new Date().toLocaleDateString() }}</p>
                        </div>
                    </div>

                    <div class="text-center mb-8">
                        <p class="text-xs text-slate-400 mb-2 uppercase">{{ getReportTitle() }}æ€»æ¶ˆè€—</p>
                        <p class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400 font-mono">
                            {{ formatBytes(reportTotalDown + reportTotalUp) }}
                        </p>
                    </div>

                    <div class="space-y-3 mb-8">
                        <p class="text-xs text-slate-500 uppercase tracking-wider mb-2">Top Consumers</p>
                        <div v-for="(item, idx) in topReportItems" :key="idx" class="flex justify-between items-center py-2 border-b border-white/5">
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-mono text-slate-600 w-4">0{{ idx + 1 }}</span>
                                <span class="text-sm font-bold text-slate-200">{{ item.name }}</span>
                            </div>
                            <span class="text-xs font-mono text-blue-400">{{ formatBytes(item.total) }}</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-end text-xs text-slate-600 mt-12">
                        <span>Powered by æº¯å…‰ Â· NAS</span>
                        <span class="font-mono">#DATA_VISUALIZATION</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const currentTab = ref('live');
                const stats = ref([]);
                const totalSpeedDown = ref(0);
                
                // æŠ¥è¡¨æ•°æ®
                const reportRange = ref('day');
                const reportData = ref({});
                const reportChart = ref(null);

                const formatBytes = (bytes) => {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                };

                const formatSpeed = (bytes) => formatBytes(bytes);

                const getIcon = (name) => {
                    name = name.toLowerCase();
                    if (name.includes('emby')) return 'ğŸ¬';
                    if (name.includes('nginx')) return 'ğŸŒ';
                    if (name.includes('qbittorrent') || name.includes('download')) return 'â¬‡ï¸';
                    return 'ğŸ“¦';
                };

                // è®¡ç®—å±æ€§
                const sortedStats = computed(() => [...stats.value].sort((a,b) => (b.up+b.down) - (a.up+a.down)));
                const totalUpload = computed(() => stats.value.reduce((acc, cur) => acc + cur.upload, 0));
                const totalDownload = computed(() => stats.value.reduce((acc, cur) => acc + cur.download, 0));

                // æŠ¥è¡¨è®¡ç®—å±æ€§
                const reportTotalUp = computed(() => {
                    let sum = 0;
                    for(let t in reportData.value) {
                        for(let n in reportData.value[t]) sum += reportData.value[t][n].up;
                    }
                    return sum;
                });
                const reportTotalDown = computed(() => {
                    let sum = 0;
                    for(let t in reportData.value) {
                        for(let n in reportData.value[t]) sum += reportData.value[t][n].down;
                    }
                    return sum;
                });
                const topReportItems = computed(() => {
                    let totals = {};
                    for(let t in reportData.value) {
                        for(let n in reportData.value[t]) {
                            if(!totals[n]) totals[n] = 0;
                            totals[n] += (reportData.value[t][n].up + reportData.value[t][n].down);
                        }
                    }
                    return Object.entries(totals)
                        .map(([name, total]) => ({name, total}))
                        .sort((a,b) => b.total - a.total)
                        .slice(0, 5);
                });

                // æ ¸å¿ƒé€»è¾‘
                const fetchRealtime = async () => {
                    try {
                        const res = await fetch('/api/realtime');
                        const data = await res.json();
                        
                        // ä¼°ç®—é€Ÿåº¦ (å’Œä¸Šæ¬¡æ•°æ®å¯¹æ¯”)
                        let currentTotal = data.reduce((acc, cur) => acc + cur.download, 0);
                        if (window.lastTotal !== undefined) {
                            let diff = currentTotal - window.lastTotal;
                            if (diff >= 0) totalSpeedDown.value = diff / 2; // 2ç§’åˆ·æ–°ä¸€æ¬¡
                        }
                        window.lastTotal = currentTotal;
                        stats.value = data;
                    } catch(e) {}
                };

                const loadHistory = async (range) => {
                    reportRange.value = range;
                    const res = await fetch(`/api/history?range=${range}`);
                    const data = await res.json();
                    reportData.value = data;
                    renderChart(data);
                };

                const renderChart = (data) => {
                    nextTick(() => {
                        const chartDom = document.getElementById('trendChart');
                        if(!reportChart.value) reportChart.value = echarts.init(chartDom, 'dark');
                        
                        const times = Object.keys(data);
                        // ç®€å•å¤„ç†ï¼šåªå–æ€»æµé‡åšè¶‹åŠ¿
                        const seriesData = times.map(t => {
                            let sum = 0;
                            for(let n in data[t]) sum += (data[t][n].down + data[t][n].up);
                            return sum;
                        });

                        reportChart.value.setOption({
                            backgroundColor: 'transparent',
                            tooltip: { trigger: 'axis' },
                            grid: { top: 10, bottom: 20, left: 10, right: 10, containLabel: false },
                            xAxis: { type: 'category', data: times, show: false },
                            yAxis: { type: 'value', show: false },
                            series: [{
                                data: seriesData,
                                type: 'line',
                                smooth: true,
                                areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'#3b82f6'},{offset:1,color:'rgba(59,130,246,0)'}]) },
                                lineStyle: { color: '#60a5fa', width: 2 },
                                showSymbol: false
                            }]
                        });
                        reportChart.value.resize();
                    });
                };

                const getReportTitle = () => {
                    const map = {day:'ä»Šæ—¥', month:'æœ¬æœˆ', year:'ä»Šå¹´'};
                    return map[reportRange.value];
                };

                const generatePoster = () => {
                    const el = document.getElementById('poster-node');
                    el.style.opacity = 1;
                    html2canvas(el, { backgroundColor: '#0f172a', scale: 2 }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `RetroFlow_${getReportTitle()}_${Date.now()}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                        el.style.opacity = 0;
                    });
                };

                onMounted(() => {
                    fetchRealtime();
                    setInterval(fetchRealtime, 2000);
                });

                return {
                    currentTab, stats, totalSpeedDown, totalUpload, totalDownload,
                    sortedStats, formatBytes, formatSpeed, getIcon,
                    reportRange, loadHistory, reportTotalUp, reportTotalDown, 
                    topReportItems, generatePoster, getReportTitle
                };
            }
        }).mount('#app');
    </script>
</body>
</html>