<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroFlow æº¯å…‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#3b82f6' } } }
        }
    </script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: none;
        }
        .status-dot {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-[#f8fafc] dark:bg-[#0f172a] text-slate-800 dark:text-slate-200 min-h-screen transition-colors duration-300">
    <div id="app" class="min-h-screen flex flex-col">
        
        <header class="sticky top-0 z-50 bg-white/80 dark:bg-[#0f172a]/90 backdrop-blur border-b border-gray-200 dark:border-white/5">
            <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center text-white font-bold">R</div>
                    <span class="font-bold text-lg tracking-tight">RetroFlow æº¯å…‰</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="hidden md:flex bg-gray-100 dark:bg-slate-800 p-1 rounded-lg">
                        <button @click="tab='live'" :class="['px-4 py-1.5 text-xs font-bold rounded-md transition-all', tab==='live'?'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-400':'text-slate-500']">å®æ—¶ç›‘æ§</button>
                        <button @click="tab='report'; loadHistory('day')" :class="['px-4 py-1.5 text-xs font-bold rounded-md transition-all', tab==='report'?'bg-white dark:bg-slate-600 shadow text-blue-600 dark:text-blue-400':'text-slate-500']">å†å²æŠ¥è¡¨</button>
                    </div>
                    <button @click="toggleTheme" class="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-800 flex items-center justify-center text-lg">{{ isDark?'ğŸŒ™':'â˜€' }}</button>
                </div>
            </div>
        </header>

        <main class="flex-1 max-w-7xl mx-auto w-full p-4 lg:p-6 space-y-6">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-panel p-4 rounded-xl flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center">ğŸ§ </div>
                    <div>
                        <div class="text-xs text-slate-500">CPU ä½¿ç”¨ç‡</div>
                        <div class="font-bold font-mono">{{ sys.cpu }}%</div>
                    </div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center">ğŸ’¾</div>
                    <div>
                        <div class="text-xs text-slate-500">å†…å­˜ä½¿ç”¨</div>
                        <div class="font-bold font-mono">{{ sys.mem_percent }}%</div>
                    </div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 flex items-center justify-center">âš¡</div>
                    <div>
                        <div class="text-xs text-slate-500">å®æ—¶æ€»ä¸‹è½½</div>
                        <div class="font-bold font-mono text-emerald-500">{{ formatBytes(totalSpeedDown) }}/s</div>
                    </div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 flex items-center justify-center">â±ï¸</div>
                    <div>
                        <div class="text-xs text-slate-500">å·²è¿è¡Œ</div>
                        <div class="font-bold font-mono">{{ uptime }}</div>
                    </div>
                </div>
            </div>

            <div v-if="tab === 'live'" class="space-y-6">
                <div class="glass-panel rounded-2xl p-5">
                    <h3 class="text-xs font-bold text-slate-400 mb-2 uppercase">å…¨ç½‘æµé‡æ³¢å½¢ (30ç§’)</h3>
                    <div id="liveChart" class="w-full h-[180px]"></div>
                </div>

                <div>
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        è¿è¡Œä¸­çš„æœåŠ¡ 
                        <span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-300">{{ sortedStats.length }}</span>
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        <div v-for="item in sortedStats" :key="item.name" class="glass-panel rounded-xl p-4 hover:-translate-y-1 transition-transform duration-300 relative group">
                            <div v-if="item.speed > 0" class="absolute top-4 right-4 w-2 h-2 rounded-full bg-emerald-500 status-dot animate-pulse"></div>

                            <div class="flex items-center gap-3 mb-4">
                                <div class="w-10 h-10 rounded-lg bg-gray-50 dark:bg-slate-800 flex items-center justify-center text-xl shadow-sm border border-gray-100 dark:border-white/5">
                                    {{ getIcon(item.name) }}
                                </div>
                                <div class="overflow-hidden">
                                    <div class="font-bold text-sm truncate" :title="item.name">{{ item.name }}</div>
                                    <div class="text-[10px] text-slate-400 bg-gray-100 dark:bg-slate-800 px-1.5 rounded inline-block mt-1">{{ item.type }}</div>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-slate-500">ä¸‹è½½æ€»é‡</span>
                                    <span class="font-mono bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400 px-1.5 py-0.5 rounded">{{ formatBytes(item.download) }}</span>
                                </div>
                                <div class="flex justify-between items-center text-xs">
                                    <span class="text-slate-500">ä¸Šä¼ æ€»é‡</span>
                                    <span class="font-mono bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20 dark:text-emerald-400 px-1.5 py-0.5 rounded">{{ formatBytes(item.upload) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="sortedStats.length === 0" class="text-center py-10 text-slate-400 text-sm">
                        æ­£åœ¨æ‰«æå®¹å™¨ä¸æµé‡...
                    </div>
                </div>
            </div>

            <div v-else class="space-y-6">
                <div class="glass-panel rounded-2xl p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-bold text-lg">æµé‡è¶‹åŠ¿åˆ†æ</h2>
                        <div class="bg-gray-100 dark:bg-slate-800 p-1 rounded-lg flex text-xs">
                            <button v-for="k in ['day','month','year']" @click="loadHistory(k)" :class="['px-3 py-1 rounded transition-all', range===k?'bg-white dark:bg-slate-600 shadow':'text-slate-500']">{{ {day:'24å°æ—¶',month:'30å¤©',year:'å…¨å¹´'}[k] }}</button>
                        </div>
                    </div>
                    <div id="trendChart" class="w-full h-[300px]"></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel rounded-2xl p-6">
                        <h3 class="font-bold text-sm mb-4">æµé‡æ¶ˆè€— TOP 5</h3>
                        <div id="pieChart" class="w-full h-[250px]"></div>
                    </div>
                    <div class="glass-panel rounded-2xl p-6 flex flex-col justify-center space-y-6">
                        <div class="flex justify-between items-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                            <div><div class="text-xs text-blue-600 dark:text-blue-400 font-bold mb-1">å‘¨æœŸæ€»ä¸‹è½½</div><div class="text-2xl font-mono font-bold text-slate-800 dark:text-white">{{ formatBytes(reportTotalDown) }}</div></div>
                            <div class="text-3xl">â¬‡ï¸</div>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl">
                            <div><div class="text-xs text-emerald-600 dark:text-emerald-400 font-bold mb-1">å‘¨æœŸæ€»ä¸Šä¼ </div><div class="text-2xl font-mono font-bold text-slate-800 dark:text-white">{{ formatBytes(reportTotalUp) }}</div></div>
                            <div class="text-3xl">â¬†ï¸</div>
                        </div>
                        <button @click="genPoster" class="w-full py-3 bg-slate-900 dark:bg-blue-600 text-white rounded-xl font-bold hover:shadow-lg transition-all">ğŸ“¸ ç”Ÿæˆæµé‡æ—¥æŠ¥</button>
                    </div>
                </div>
            </div>

        </main>

        <div id="poster" class="fixed -left-[9999px] top-0 w-[400px] bg-[#1e293b] p-8 text-white">
            <div class="border border-white/10 rounded-3xl p-6 bg-gradient-to-br from-[#0f172a] to-[#1e293b]">
                <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-1">RetroFlow</h1>
                <p class="text-xs text-slate-400 mb-8 uppercase tracking-widest">{{ new Date().toLocaleDateString() }} æµé‡æˆ˜æŠ¥</p>
                <div class="text-center py-8 border-y border-white/5 mb-8">
                    <div class="text-xs text-slate-500 mb-2">å½“æ—¥æ€»æµé‡</div>
                    <div class="text-4xl font-mono font-bold">{{ formatBytes(reportTotalDown + reportTotalUp) }}</div>
                </div>
                <div class="space-y-3">
                    <div v-for="(x,i) in topItems" :key="i" class="flex justify-between text-sm py-2 border-b border-white/5">
                        <span class="text-slate-300">0{{i+1}} {{x.name}}</span>
                        <span class="font-mono text-blue-400">{{ formatBytes(x.value) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const isDark = ref(localStorage.getItem('theme')==='dark');
                const tab = ref('live');
                const stats = ref([]);
                const sys = ref({ cpu:0, mem_percent:0 });
                const uptime = ref('0h 0m');
                const totalSpeedDown = ref(0);
                
                // å›¾è¡¨
                const chartData = ref(new Array(30).fill(0));
                let liveChart, trendChart, pieChart;

                const toggleTheme = () => {
                    isDark.value = !isDark.value;
                    const html = document.documentElement;
                    isDark.value ? html.classList.add('dark') : html.classList.remove('dark');
                    localStorage.setItem('theme', isDark.value?'dark':'light');
                    if(liveChart) liveChart.dispose();
                    initLiveChart();
                };

                const formatBytes = (bytes) => {
                    if (bytes === 0) return '0 B';
                    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + sizes[i];
                };

                const getIcon = (name) => {
                    name = name.toLowerCase();
                    if(name.includes('emby')||name.includes('plex')) return 'ğŸ¬';
                    if(name.includes('web')||name.includes('nginx')) return 'ğŸŒ';
                    if(name.includes('mysql')||name.includes('redis')) return 'ğŸ—„ï¸';
                    if(name.includes('qb')||name.includes('trans')) return 'â¬‡ï¸';
                    if(name.includes('ssh')) return 'ğŸ’»';
                    return 'ğŸ“¦';
                };

                const sortedStats = computed(() => [...stats.value].sort((a,b)=>(b.upload+b.download)-(a.upload+a.download)));

                const initLiveChart = () => {
                    const el = document.getElementById('liveChart');
                    if(!el) return;
                    liveChart = echarts.init(el, isDark.value?'dark':undefined);
                    liveChart.setOption({
                        backgroundColor: 'transparent',
                        grid: {top:5,bottom:0,left:0,right:0},
                        xAxis: {show:false, data:new Array(30).fill('')},
                        yAxis: {show:false},
                        series: [{
                            type: 'line', data: chartData.value, smooth: true, showSymbol: false,
                            lineStyle: {width:3, color:'#3b82f6'},
                            areaStyle: {color: new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(59,130,246,0.5)'},{offset:1,color:'rgba(59,130,246,0)'}])}
                        }]
                    });
                };

                const fetchData = async () => {
                    try {
                        const res = await fetch('/api/status');
                        const data = await res.json();
                        sys.value = data.system;
                        stats.value = data.containers;

                        // è®¡ç®—æ€»é€Ÿ
                        let currDown = 0;
                        stats.value.forEach(s => currDown += s.download);
                        if(window.lastDown !== undefined) {
                            let diff = currDown - window.lastDown;
                            totalSpeedDown.value = diff > 0 ? diff/2 : 0;
                        }
                        window.lastDown = currDown;

                        // è¿è¡Œæ—¶é—´
                        const now = Date.now()/1000;
                        const diff = now - sys.value.boot_time;
                        const h = Math.floor(diff/3600);
                        const m = Math.floor((diff%3600)/60);
                        uptime.value = `${h}å°æ—¶ ${m}åˆ†`;

                        // æ›´æ–°å›¾è¡¨
                        chartData.value.shift();
                        chartData.value.push(totalSpeedDown.value);
                        if(liveChart) liveChart.setOption({series:[{data:chartData.value}]});
                    } catch(e){}
                };

                // æŠ¥è¡¨é€»è¾‘
                const range = ref('day');
                const reportTotalUp = ref(0);
                const reportTotalDown = ref(0);
                const topItems = ref([]);

                const loadHistory = async (r) => {
                    range.value = r;
                    nextTick(async ()=>{
                        const res = await fetch(`/api/history?range=${r}`);
                        const data = await res.json();
                        renderCharts(data);
                    });
                };

                const renderCharts = (data) => {
                    const times = Object.keys(data);
                    let seriesData = [], pieD = {};
                    let tup = 0, tdown = 0;

                    times.forEach(t => {
                        let sum = 0;
                        for(let n in data[t]) {
                            const v = data[t][n].up + data[t][n].down;
                            sum += v;
                            tup += data[t][n].up; tdown += data[t][n].down;
                            pieD[n] = (pieD[n]||0) + v;
                        }
                        seriesData.push(sum);
                    });
                    reportTotalUp.value = tup; reportTotalDown.value = tdown;
                    topItems.value = Object.entries(pieD).map(([name,value])=>({name,value})).sort((a,b)=>b.value-a.value).slice(0,5);

                    // æ¸²æŸ“
                    const tEl = document.getElementById('trendChart');
                    if(tEl) {
                        if(trendChart) trendChart.dispose();
                        trendChart = echarts.init(tEl, isDark.value?'dark':undefined);
                        trendChart.setOption({
                            backgroundColor:'transparent', tooltip:{trigger:'axis'},
                            grid:{left:0,right:0,top:10,bottom:0,containLabel:true},
                            xAxis:{type:'category',data:times,show:false},
                            yAxis:{type:'value',splitLine:{lineStyle:{type:'dashed',opacity:0.2}}},
                            series:[{type:'line',data:seriesData,smooth:true,areaStyle:{opacity:0.2},itemStyle:{color:'#3b82f6'}}]
                        });
                    }
                    const pEl = document.getElementById('pieChart');
                    if(pEl) {
                        if(pieChart) pieChart.dispose();
                        pieChart = echarts.init(pEl, isDark.value?'dark':undefined);
                        pieChart.setOption({
                            backgroundColor:'transparent', tooltip:{trigger:'item'},
                            series:[{type:'pie',radius:['40%','70%'],data:topItems.value,itemStyle:{borderRadius:5,borderColor:isDark.value?'#1e293b':'#fff',borderWidth:2}}]
                        });
                    }
                };

                const genPoster = () => {
                    html2canvas(document.getElementById('poster')).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'RetroFlow_Report.png';
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                };

                onMounted(() => {
                    if(isDark.value) document.documentElement.classList.add('dark');
                    initLiveChart();
                    fetchData();
                    setInterval(fetchData, 2000);
                });

                return { isDark, toggleTheme, tab, stats, sys, uptime, totalSpeedDown, sortedStats, formatBytes, getIcon, range, loadHistory, reportTotalUp, reportTotalDown, topItems, genPoster };
            }
        }).mount('#app');
    </script>
</body>
</html>